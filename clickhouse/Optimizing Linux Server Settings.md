## Optimizing Linux Server Settings for Enhanced ClickHouse Performance: A Guide for High-Volume Data Ingestion
#### Improving Linux Server Configurations for Better ClickHouse Performance: Strategies for Managing Large Data Volumes

Оптимизация Linux-сервера для работы с ClickHouse, особенно для обработки больших объемов данных с высокой скоростью, требует многоуровневой настройки системы. Эти усовершенствования призваны повысить производительность ClickHouse за счет использования всего потенциала базовой системы Linux. Вот несколько практических советов по настройке Linux-сервера для повышения производительности ClickHouse:

1. Увеличьте количество файловых дескрипторов

ClickHouse может одновременно открывать множество файлов, особенно в средах с высокой нагрузкой. Увеличьте количество доступных файловых дескрипторов, чтобы избежать ошибок «Слишком много открытых файлов».

 - Измените лимиты:

```
  # Edit /etc/security/limits.conf
  * soft nofile 262144
  * hard nofile 262144
```

 - Примените изменения:
   
 ```
   # For the changes to take effect without rebooting
  ulimit -n 262144
 ```

 2. Оптимизируйте сетевые параметры

 Чтобы улучшить обработку больших объемов входящих подключений и данных, оптимизируйте стек TCP:

  - Увеличьте объём работы и буферы:

```
# Edit /etc/sysctl.conf
net.core.somaxconn = 4096net.core.netdev_max_backlog = 10000
net.ipv4.tcp_max_syn_backlog = 4096
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
```

 - Примените изменения:

 ```
 sysctl -p
 ```

 3. Настройка расписания ввода-вывода:

 Планировщик ввода-вывода по умолчанию может оказаться неоптимальным для рабочих нагрузок базы данных. Изменение планировщика на deadline или noop может повысить производительность твердотельных накопителей:

- Измените планировщик для SSD:
  
```
echo 'deadline' > /sys/block/sda/queue/scheduler
```

4. Оптимизация файловой системы

Использование файловых систем XFS или EXT4 может повысить производительность. XFS особенно рекомендуется за её масштабируемость и производительность при работе с большими файлами.

- Параметры монтирования: При монтировании файловых систем используйте параметры, которые уменьшают задержку и повышают пропускную способность:

```
# For example, mounting an XFS file system
mount -o noatime,nodiratime /dev/sda /var/lib/clickhouse
```

5. Минимизируйте использование файла подкачки

Возможность подкачки определяет степень, в которой система предпочитает подкачку оперативной памяти. Для систем баз данных предпочтительно меньшее значение, чтобы заставить ядро Linux более активно использовать оперативную память.

- Уменьшить использование файла подкачки

```
# Set swappiness to a lower value
sysctl vm.swappiness=10
```

6. Настройка масштабирования частоты процессора

Убедитесь, что масштабирование частоты процессора настроено на режим производительности, чтобы предотвратить колебания тактовой частоты процессора, которые могут повлиять на задержку:

- Переведите процессор в режим повышенной производительности:

```
# Apply to all CPUs
for CPU in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
do
  echo performance > $CPU
done
```

7. Отключите Transparent Huge Pages (THP)

Технология THP может привести к снижению производительности баз данных из-за особенностей управления памятью. Часто её лучше отключить:

- Отключить THP

```
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag
```
